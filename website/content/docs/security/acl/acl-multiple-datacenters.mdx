---
layout: docs
page_title: ACL in Multiple Datacenters
description: >-
  When Consul ACLs are enabled in multiple datacenters that are federated together,
  specific bootstrapping of ACLs and policies are needed
---

# ACLs in Federated Datacenters

This topic describes how to set up Consul's access control list (ACL) system
in cluster deployments that span multiple data centers. This documentation is applicable
to new clusters rather than existing clusters.

-> **1.4.0 and later:** This guide only applies in Consul versions 1.4.0 and later.

## Configure ACLs in the Primary Datacenter

In a federated Consul deployment, one of the datacenters is marked as the primary datacenter.
The `acl` configuration block should be added to the primary datacenter server's configuration file
as shown in the following example.

See the [ACL Config Stanza](https://www.consul.io/docs/agent/options#acl) for more detailed descriptions of each option.

-> **Versions before 1.11.0:** The `initial_management` token was called the `master` token in versions
prior to 1.11.0

<CodeTabs heading="ACL Configuration in Primary">

```hcl
bootstrap_expect =  3
primary_datacenter =  "PRIMARY_DATACENTER_VALUE"
acl = {
 enabled =  true
 default_policy = "deny"
 down_policy = "deny"
 enable_token_persistence = true
 enable_token_replication = true
 tokens = {
   initial_management =  "ACL_MANAGEMENT_TOKEN"
   agent = "YOUR_ACL_AGENT_TOKEN"
  }
}

```

```json
{
  "bootstrap_expect": N,
  "primary_datacenter": "PRIMARY_DATACENTER_VALUE",
  "acl": {
    "enabled": true,
    "default_policy": "deny",
    "down_policy": "deny",
    "enable_token_persistence": true,
    "enable_token_replication": true,
    "tokens": {
      "initial_management": "ACL_MANAGEMENT_TOKEN",
      "agent": "ACL_AGENT_TOKEN"
    }
  }
}
```

</CodeTabs>

~> **Warning:** Note that most enterprise deployments have security requirements that prevent specifying tokens in configuration files.
Additionally, in the above config `enable_token_persistence` flag is set, so the token is stored to disk in the agent's
`data` directory. Any future changes to the token that are made through the [API](/api/agent#update-acl-tokens) will
be persisted to the same location, and the value in the config file is ignored.

The ACL agent token can also be set using the CLI as shown below.

```
$ consul acl set-agent-token agent "<agent token here>"
```

## Configure Servers in Secondary Datacenters

Servers in secondary data centers must be configured to point to the primary data center
as shown in the following example. Secondary data centers also need the acl replication token
provided to them.

### Create the replication token for ACL Management

Replication tokens are needed for ACL token replication and
to create both [local tokens](/api/acl/tokens#local) and [auth methods](/docs/acl/auth-methods)
in connected secondary datacenters.

Replication tokens need specific permissions as described below

- acl = "write" which will allow you to replicate tokens.
- operator = "write" for replicating proxy-default configuration entries and enabling CA certificate signing in the secondary datacenter.
- service_prefix, policy = "read" and intentions = "read" for replicating service-default configuration entries, CA, and intention data.

<CodeTabs heading="Replication Token Policy">

<CodeBlockConfig filename="replication-policy.hcl">

```hcl
acl = "write"
operator = "write"
service_prefix "" {
  policy = "read"
  intentions = "read"
}
```

</CodeBlockConfig>
</CodeTabs>

Create a replication policy with the following command:

```
$ consul acl policy create -name replication -rules @replication-policy.hcl
```

Use your newly created policy to create the replication token.

```
$ consul acl token create -description "replication token" -policy-name replication
```

### Configure the replication token in Secondary Datacenters

Add the replication token generated above, to the ACL stanza in secondary datacenters.

<CodeTabs heading = "ACL Configuration in Secondaries">

```hcl
primary_datacenter = "PRIMARY_DATACENTER_NAME"
acl = {
   enabled = true
   default_policy =  "deny"
   down_policy =  "deny"
   tokens = {
      agent =  "ACL_AGENT_TOKEN"
      replication = "ACL_REPLICATION_TOKEN"
   }
}
```

```json
{
  "primary_datacenter": "PRIMARY_DATACENTER_VALUE",
  "acl": {
    "enabled": true,
    "default_policy": "deny",
    "down_policy": "deny",
    "tokens": {
      "agent": "ACL_AGENT_TOKEN"
    }
  }
}
```

</CodeTabs>

~> **Warning:** When enabling ACL token replication in secondary datacenters,
global tokens already present in the secondary datacenter will be lost. For
production environments, consider configuring ACL replication in your initial
datacenter bootstrapping process.

## WAN Join Servers

This step is needed for new federated cluster deployments in order for
servers in each federated datacenter to discover each other.

Run the following command from one of the server nodes.

```
$ consul join -token="ACL_MANAGEMENT_TOKEN" -wan [server 1, server 2, ...]
```

## Configure Clients in Secondary Datacenters

When ACLs are enabled, client agents need a special token known as the `agent token` for ACL
related operations. Agent tokens need to have the right policies for node related actions including
registering itself in the catalog, updating node level health checks, and having write access on its
agent configuration file.

### Generate Agent ACL Token

[ACL Node Identities](https://www.consul.io/docs/security/acl/acl-system#acl-node-identities) were introduced
in Consul 1.8.1 and enable creating agent tokens with appropriately scoped policies easily.

To generate the ACL token using node identity, run the following command:

```
$ consul acl token create -node-identity=node-two:dc2
```

### Configure clients to use the ACL agent token

The client agents should then be updated to contain the token value from the above step. Replace
the `ACL_AGENT_TOKEN` value below with the token value from the command output.

<CodeTabs heading = "ACL Configuration in Client Agents">

```hcl
primary_datacenter = "PRIMARY_DATACENTER_NAME"
acl = {
   enabled = true
   default_policy =  "deny"
   down_policy =  "deny"
   tokens = {
      agent =  "ACL_AGENT_TOKEN"
   }
}
```

```json
{
  "primary_datacenter": "PRIMARY_DATACENTER_VALUE",
  "acl": {
    "enabled": true,
    "default_policy": "deny",
    "down_policy": "deny",
    "tokens": {
      "agent": "ACL_AGENT_TOKEN"
    }
  }
}
```

</CodeTabs>

Note that client agents have to be restarted for ACL related configuration changes to take effect.

## Summary

After completing the above steps, a federated Consul cluster can be used with ACLs. Refer to
[ACL Replication Guide](https://learn.hashicorp.com/tutorials/consul/access-control-replication-multiple-datacenters?in=consul/security-operations)
for more on this topic.
